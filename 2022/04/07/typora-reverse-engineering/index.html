<!-- build time: Wed Sep 10 2025 16:11:04 GMT+0800 (中国标准时间) --><!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta http-equiv="X-UA-COMPATIBLE" content="IE=edge,chrome=1"><meta name="renderer" content="webkit"><link rel="icon" type="image/ico" sizes="32x32" href="/assets/favicon.ico"><link rel="apple-touch-icon" sizes="180x180" href="/assets/apple-touch-icon.png"><meta name="google-site-verification" content="ZTJV7LmnjnAU0rDyvzCr7TRRA440DNEQPOSHt9OiYLE"><link rel="alternate" href="/rss.xml" title="symlpigeon's little gensokyo" type="application/rss+xml"><link rel="alternate" href="/atom.xml" title="symlpigeon's little gensokyo" type="application/atom+xml"><link rel="alternate" type="application/json" title="symlpigeon's little gensokyo" href="http://symlpigeon.github.io/feed.json"><link rel="preconnect" href="https://s4.zstatic.net"><link rel="preconnect" href="https://at.alicdn.com"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Mulish:400,400italic,700,700italic%7CFredericka%20the%20Great:400,400italic,700,700italic%7CNoto%20Serif%20JP:400,400italic,700,700italic%7CNoto%20Serif%20SC:400,400italic,700,700italic%7CInconsolata:400,400italic,700,700italic&display=swap&subset=latin,latin-ext" media="none" onload="this.media&#x3D;&#39;all&#39;"><link rel="stylesheet" href="/css/app.css?v=0.4.25"><link rel="modulepreload" href="/js/chunk-4ZVORXXI.js"><link rel="modulepreload" href="/js/chunk-QTIRA53W.js"><link rel="modulepreload" href="/js/copy-tex-SCXHUQKS.js"><link rel="modulepreload" href="/js/post-XSNAZ6TV.js"><link rel="modulepreload" href="/js/quicklink-P2UCCMRY.js"><link rel="modulepreload" href="/js/siteInit.js"><link rel="preload" href="/assets/index-bg.jpg" as="image" fetchpriority="high"><meta name="keywords" content="逆向工程"><meta name="description" content="Typora在正式版之后开始付费了，在更新的版本中似乎和原先的注册认证机制不太一样，所以说进行一个逆向来看一下实际是什么样子的。另外也可以把这个作为对Electron app逆向的一个参考？"><link rel="canonical" href="http://symlpigeon.github.io/2022/04/07/typora-reverse-engineering/"><script src="https://cdn.jsdelivr.net/npm/echarts@5.4.0/dist/echarts.min.js"></script><style type="text/css">#categories-chart,#categories-radar,#posts-calendar,#posts-chart,#tags-chart{width:100%;height:300px;margin:.5rem auto;padding:.5rem;overflow-x:auto}</style><title>针对Typora的逆向分析</title><meta name="generator" content="Hexo 7.3.0"></head><body itemscope itemtype="http://schema.org/WebPage"><div id="loading"><div class="cat"><div class="body"></div><div class="head"><div class="face"></div></div><div class="foot"><div class="tummy-end"></div><div class="bottom"></div><div class="legs left"></div><div class="legs right"></div></div><div class="paw"><div class="hands left"></div><div class="hands right"></div></div></div></div><div id="container"><header id="header" itemscope itemtype="http://schema.org/WPHeader"><div class="inner"><div id="brand"><div class="pjax"><h1 itemprop="name headline">针对Typora的逆向分析</h1><div class="meta"><span class="item" title="创建时间：2022-04-07 11:51:40"><span class="icon"><i class="ic i-calendar"></i></span><span class="text">发表于</span><time itemprop="dateCreated datePublished" datetime="2022-04-07T11:51:40+08:00">2022-04-07</time></span><span class="item" title="本文字数"><span class="icon"><i class="ic i-pen"></i></span><span class="text">本文字数</span><span>13k</span><span class="text">字</span></span><span class="item" title="阅读时长"><span class="icon"><i class="ic i-clock"></i></span><span class="text">阅读时长</span><span>12 分钟</span></span></div></div></div><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="切换导航栏"><span class="line"></span><span class="line"></span><span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/" rel="start">Another Gensokyo</a></li></ul><ul class="right" id="rightNav"><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div class="pjax" id="imgs"><img src="/assets/index-bg.jpg" loading="eager" decoding="async" fetchpriority="high" alt="symlpigeon's little gensokyo"></div></header><div id="waves"><svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"></path></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"></use><use xlink:href="#gentle-wave" x="48" y="3"></use><use xlink:href="#gentle-wave" x="48" y="5"></use><use xlink:href="#gentle-wave" x="48" y="7"></use></g></svg></div><main><div class="inner"><div class="pjax" id="main"><div class="article wrap"><div class="breadcrumb" itemlistelement itemscope itemtype="https://schema.org/BreadcrumbList"><i class="ic i-home"></i><span><a href="/">首页</a></span><i class="ic i-angle-right"></i><span itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/%E4%BA%8C%E8%BF%9B%E5%88%B6/" itemprop="item" rel="index" title="分类于二进制"><span itemprop="name">二进制<meta itemprop="position" content="0"></span></a></span><i class="ic i-angle-right"></i><span class="current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/%E4%BA%8C%E8%BF%9B%E5%88%B6/%E5%AE%9E%E8%B7%B5/" itemprop="item" rel="index" title="分类于实践"><span itemprop="name">实践<meta itemprop="position" content="1"></span></a></span></div><article class="post block" itemscope itemtype="http://schema.org/Article" lang="zh-CN"><link itemprop="mainEntityOfPage" href="http://symlpigeon.github.io/2022/04/07/typora-reverse-engineering/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/assets/avatar.png"><meta itemprop="name" content="神隐陌路/symlPigeon"><meta itemprop="description" content="神隐陌路的个人小站, 夢違え、幻の朝靄の世界の記憶を"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="symlpigeon's little gensokyo"></span><div class="body md" itemprop="articleBody"><blockquote><p>《信息网络传播权保护条例》第十八条、第十九条规定：“任何人不得故意避开、破坏或故意制造、向他人提供主要用于避开、破坏技术措施的装置或者部件，或者故意为他人避开或者破坏技术措施提供技术服务的，否则需要承担相应的民事责任、行政责任及刑事责任；</p><p>《计算机软件保护条例》第十四条规定：未经软件著作权人许可，不得故意避开或者破坏著作权人为保护其软件著作权而采取的技术措施的，否则需要承担相应的民事责任、行政责任及刑事责任。”</p><p>《中华人民共和国刑法》第二百八十六条 破坏计算机信息系统罪：违反国家规定，对计算机信息系统功能进行删除、修改、增加、干扰，造成计算机信息系统不能正常运行，后果严重的，处五年以下有期徒刑或者拘役；后果特别严重的，处五年以上有期徒刑。</p></blockquote><blockquote><p><strong>此内容仅为学习、交流，请勿非法用途使用！</strong></p></blockquote><p>之前写 markdown 一直都用的是 Typora（当然也会用 vscode），后来 Typora 付费了之后也就买了正版，这次看到有关于这个的逆向分析，也就来了一些兴趣觉得可以做一做。</p><p><img loading="lazy" data-src="typora-active.jpg" alt="我没白嫖"></p><p>实际上这次做这个先是看了相关的逆向分析帖子，所以说整个思路基本上也就是按照人家的来做的。Windows 下面和 Linux 下面的 Typora 还有些不太一样，这里就拿 Windows 下面的为例。</p><h1 id="外面的保护"><a class="anchor" href="#外面的保护">#</a> 外面的保护</h1><p>我们如果去阅读 Electron 相关的开发资料也就可以知道，在项目下面的 <code>resources/app.asar</code> 中间是项目实际运行有关的源码等文件。我们首先要做的也就是要去将这个文件进行解包。参考 <code>asar</code> 的使用指令，安装了之后这样进行解包：</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">npm</span> <span class="token function">install</span> <span class="token parameter variable">-g</span> asar</pre></td></tr><tr><td data-num="2"></td><td><pre>asar extract /path/to/app.asar /path/to/extracted</pre></td></tr></table></figure><p>我们解包之后就会得到三个文件： <code>atom.js</code> ， <code>main.node</code> ， <code>package.json</code> 。其中 <code>package.json</code> 是打包有关的内容，我们暂且不需要关。</p><p>打开 <code>atom.js</code> 文件之后，发现里面是 base64 格式的编码。</p><p><img loading="lazy" data-src="base64-atom.jpg" alt=""></p><p>用 cyberchef 之类的工具解码发现还是乱码，看不出什么东西来，很明显是加密之后的内容。</p><p><img loading="lazy" data-src="b64-decode.jpg" alt="记住Hex的前面一些字节，后面有用"></p><p>那下面要看的也就是 <code>main.node</code> ，拖进 detect it easy 可以看到这是个 64 位的动态链接库。</p><p><img loading="lazy" data-src="main-node-die.jpg" alt=""></p><p>理所当然地，拖进 IDA。</p><p>直接看也看不出什么东西，包括字符串也找不到什么有用的内容。不过用 FindCrypto 可以找到一些有趣的东西。</p><p><img loading="lazy" data-src="find-crypto.jpg" alt=""></p><p>这里找到了 AES 的密码学组件，接下来顺着调用关系向上寻找。以 <code>RijnDael_AES_LONG_inv_180056F60</code> 为入手点，它在函数 <code>sub_180007320</code> 中被使用。</p><p>接下来来看这个函数，按照惯例还是 F5 一下， <code>__int64 __fastcall sub_180007320(unsigned __int8 *a1, __int64 a2)</code> 接收两个参数 <code>a1</code> 和 <code>a2</code> 。</p><p>这个函数体比较长，我们挑出其中的几段来看：</p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre>v2 <span class="token operator">=</span> a1<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  v3 <span class="token operator">=</span> a2 <span class="token operator">-</span> <span class="token punctuation">(</span>_QWORD<span class="token punctuation">)</span>a1<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  v4 <span class="token operator">=</span> <span class="token number">4</span>i64<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token keyword">do</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    v5 <span class="token operator">=</span> <span class="token number">4</span>i64<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token keyword">do</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>      <span class="token operator">*</span>a1 <span class="token operator">^=</span> a1<span class="token punctuation">[</span>v3 <span class="token operator">+</span> <span class="token number">224</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>      <span class="token operator">++</span>a1<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>      <span class="token operator">--</span>v5<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token keyword">while</span> <span class="token punctuation">(</span> v5 <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token operator">--</span>v4<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>  <span class="token keyword">while</span> <span class="token punctuation">(</span> v4 <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p><code>v2</code> 取 <code>a1</code> 的地址， <code>v3</code> 取 <code>a2</code> 的地址减去 <code>a1</code> 的地址也就是一个偏移量，实际上后面异或语句 <code>*a1 ^= a1[v3 + 224];</code> 也就是 <code>a1[i] ^= a2[i + 224]</code> 这样的功能。这一段代码的功能也就是将 <code>a1</code> 每一个字节和 <code>a2</code> 的 224 字节开始的位置进行异或。 <code>v2</code> 则是起到了一个保存 <code>a1</code> 的作用，因为 <code>a1</code> 在循环中被改掉了。</p><p>另外也能看出来这个分组实际上就是 16 字节，基本上就可以猜出来这是 AES 的轮密钥加。</p><p>下面这一段代码基本上就能够看出来 AES 循环的形状：</p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre>v6 <span class="token operator">=</span> <span class="token number">13</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  v7 <span class="token operator">=</span> v3 <span class="token operator">+</span> <span class="token number">208</span><span class="token punctuation">;</span> <span class="token comment">// 224 - 16 = 208</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  <span class="token keyword">do</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token comment">// 轮函数函数体</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token keyword">while</span> <span class="token punctuation">(</span> v6 <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>可以看到这个函数执行了 13 轮循环，也就是 AES-256 的执行的轮数。 <code>v7</code> 相较于上一次递减 16，这个也就是 AES 的轮密钥的长度 ——16 字节。<br>接下来是轮函数体：</p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// 行移位</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    v8 <span class="token operator">=</span> v2<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    v9 <span class="token operator">=</span> v2<span class="token punctuation">[</span><span class="token number">13</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    v10 <span class="token operator">=</span> <span class="token number">4</span>i64<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    v2<span class="token punctuation">[</span><span class="token number">13</span><span class="token punctuation">]</span> <span class="token operator">=</span> v2<span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    v2<span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span> <span class="token operator">=</span> v2<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    v2<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> v2<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    v11 <span class="token operator">=</span> v2<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    v2<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> v9<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    v12 <span class="token operator">=</span> v2<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    v2<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> v11<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    v13 <span class="token operator">=</span> v2<span class="token punctuation">[</span><span class="token number">14</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    v2<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span> <span class="token operator">=</span> v12<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    v14 <span class="token operator">=</span> v2<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    v2<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token operator">=</span> v13<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    v15 <span class="token operator">=</span> v2<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    v2<span class="token punctuation">[</span><span class="token number">14</span><span class="token punctuation">]</span> <span class="token operator">=</span> v14<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    v16 <span class="token operator">=</span> v2<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    v2<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> v15<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    v2<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span> <span class="token operator">=</span> v2<span class="token punctuation">[</span><span class="token number">11</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    v2<span class="token punctuation">[</span><span class="token number">11</span><span class="token punctuation">]</span> <span class="token operator">=</span> v2<span class="token punctuation">[</span><span class="token number">15</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    v2<span class="token punctuation">[</span><span class="token number">15</span><span class="token punctuation">]</span> <span class="token operator">=</span> v16<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token comment">// 字节替换</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token keyword">do</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>      v17 <span class="token operator">=</span> v8<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>      v18 <span class="token operator">=</span> <span class="token number">4</span>i64<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>      <span class="token keyword">do</span></pre></td></tr><tr><td data-num="29"></td><td><pre>      <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>        v19 <span class="token operator">=</span> <span class="token operator">*</span>v17<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>        v17 <span class="token operator">+=</span> <span class="token number">4</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>        <span class="token operator">*</span><span class="token punctuation">(</span>v17 <span class="token operator">-</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">=</span> RijnDael_AES_LONG_inv_180056F60<span class="token punctuation">[</span>v19<span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>        <span class="token operator">--</span>v18<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>      <span class="token keyword">while</span> <span class="token punctuation">(</span> v18 <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>      <span class="token operator">++</span>v8<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>      <span class="token operator">--</span>v10<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>    <span class="token keyword">while</span> <span class="token punctuation">(</span> v10 <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>    <span class="token comment">// 轮密钥加</span></pre></td></tr><tr><td data-num="41"></td><td><pre>    v20 <span class="token operator">=</span> v2<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>    v21 <span class="token operator">=</span> <span class="token number">4</span>i64<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>    <span class="token keyword">do</span></pre></td></tr><tr><td data-num="44"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>      v22 <span class="token operator">=</span> <span class="token number">4</span>i64<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>      <span class="token keyword">do</span></pre></td></tr><tr><td data-num="47"></td><td><pre>      <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>        <span class="token operator">*</span>v20 <span class="token operator">^=</span> v20<span class="token punctuation">[</span>v7<span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>        <span class="token operator">++</span>v20<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="50"></td><td><pre>        <span class="token operator">--</span>v22<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="52"></td><td><pre>      <span class="token keyword">while</span> <span class="token punctuation">(</span> v22 <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="53"></td><td><pre>      <span class="token operator">--</span>v21<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="54"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="55"></td><td><pre>    <span class="token keyword">while</span> <span class="token punctuation">(</span> v21 <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="56"></td><td><pre>    <span class="token comment">// 列混合</span></pre></td></tr><tr><td data-num="57"></td><td><pre>    <span class="token function">sub_180007540</span><span class="token punctuation">(</span>v2<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="58"></td><td><pre>    v7 <span class="token operator">-=</span> <span class="token number">16</span>i64<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="59"></td><td><pre>    <span class="token operator">--</span>v6<span class="token punctuation">;</span></pre></td></tr></table></figure><p>其中调用的 <code>sub_180007540</code> 函数是进行的列混合操作，可以从伪代码中看出来，这里就不放上来了。</p><p>可以看出来这个函数实际上就是 AES-256 的解密过程。</p><p>继续向上一级， <code>__int64 __fastcall sub_180006AC0(__int64 a1, unsigned __int8 *a2, unsigned int a3)</code> 这个函数。</p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre>__int64 __fastcall <span class="token function">sub_180006AC0</span><span class="token punctuation">(</span>__int64 a1<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> __int8 <span class="token operator">*</span>a2<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> a3<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  <span class="token keyword">unsigned</span> __int8 <span class="token operator">*</span>v3<span class="token punctuation">;</span> <span class="token comment">// rbx</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  __int64 v5<span class="token punctuation">;</span> <span class="token comment">// rdi</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token keyword">unsigned</span> __int64 v6<span class="token punctuation">;</span> <span class="token comment">// rsi</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  __int128 v7<span class="token punctuation">;</span> <span class="token comment">// xmm0</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  __int64 v8<span class="token punctuation">;</span> <span class="token comment">// rcx</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  __int64 result<span class="token punctuation">;</span> <span class="token comment">// rax</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span> a3 <span class="token punctuation">)</span> <span class="token comment">// 密文总长度</span></pre></td></tr><tr><td data-num="11"></td><td><pre>  <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    v3 <span class="token operator">=</span> a2<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    v5 <span class="token operator">=</span> a1 <span class="token operator">+</span> <span class="token number">240</span> <span class="token operator">-</span> <span class="token punctuation">(</span>_QWORD<span class="token punctuation">)</span>a2<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    v6 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> __int64<span class="token punctuation">)</span>a3 <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// block size = 16</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token keyword">do</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>      v7 <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span>_OWORD <span class="token operator">*</span><span class="token punctuation">)</span>v3<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>      <span class="token function">aes_ecb_decrypt</span><span class="token punctuation">(</span>v3<span class="token punctuation">,</span> a1<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 前面的解密函数</span></pre></td></tr><tr><td data-num="19"></td><td><pre>      v8 <span class="token operator">=</span> <span class="token number">16</span>i64<span class="token punctuation">;</span>              <span class="token comment">// block size = 16</span></pre></td></tr><tr><td data-num="20"></td><td><pre>      <span class="token keyword">do</span></pre></td></tr><tr><td data-num="21"></td><td><pre>      <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        result <span class="token operator">=</span> v3<span class="token punctuation">[</span>v5<span class="token punctuation">]</span><span class="token punctuation">;</span>       <span class="token comment">// 分块将密文解密后的结果和上一块异或</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token operator">*</span>v3<span class="token operator">++</span> <span class="token operator">^=</span> result<span class="token punctuation">;</span>       <span class="token comment">// 经典的 CBC 模式</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token operator">--</span>v8<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>      <span class="token keyword">while</span> <span class="token punctuation">(</span> v8 <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>      v5 <span class="token operator">-=</span> <span class="token number">16</span>i64<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>      <span class="token operator">*</span><span class="token punctuation">(</span>_OWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> <span class="token number">240</span><span class="token punctuation">)</span> <span class="token operator">=</span> v7<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>      <span class="token operator">--</span>v6<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token keyword">while</span> <span class="token punctuation">(</span> v6 <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>  <span class="token keyword">return</span> result<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>可以看出来这个函数实际上就是 AES-CBC 模式的解密函数。第一个参数 <code>a1</code> 是所有的轮密钥，第二个参数 <code>a2</code> 是指向密文 / 明文的指针，第三个参数 <code>a3</code> 是密文总长度。</p><p>继续向上一级查看。上一级是 <code>sub_180003E40</code> 函数，这个函数非常的长。</p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  v6 <span class="token operator">=</span> <span class="token operator">*</span>a2<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token function">napi_get_named_property</span><span class="token punctuation">(</span><span class="token operator">*</span>a2<span class="token punctuation">,</span> Block<span class="token punctuation">,</span> <span class="token string">"Buffer"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>v29<span class="token punctuation">)</span> <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token function">sub_180003250</span><span class="token punctuation">(</span>v42<span class="token punctuation">,</span> v6<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token function">CxxThrowException</span><span class="token punctuation">(</span>v42<span class="token punctuation">,</span> <span class="token punctuation">(</span>_ThrowInfo <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>_TI4_AVError_Napi__<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  v7 <span class="token operator">=</span> v29<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  v27 <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>a3 <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  v8 <span class="token operator">=</span> <span class="token operator">*</span>a2<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token function">napi_create_string_utf8</span><span class="token punctuation">(</span><span class="token operator">*</span>a2<span class="token punctuation">,</span> <span class="token string">"base64"</span><span class="token punctuation">,</span> <span class="token number">6</span>i64<span class="token punctuation">,</span> <span class="token operator">&amp;</span>v25<span class="token punctuation">)</span> <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="12"></td><td><pre>  <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token function">sub_180003250</span><span class="token punctuation">(</span>v42<span class="token punctuation">,</span> v8<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token function">CxxThrowException</span><span class="token punctuation">(</span>v42<span class="token punctuation">,</span> <span class="token punctuation">(</span>_ThrowInfo <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>_TI4_AVError_Napi__<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>  v28 <span class="token operator">=</span> v25<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></pre></td></tr></table></figure><p>函数最开始是这样的一段代码，基本上可以看出来是调用了 node js API 进行了读取和 base64 解码的操作，操作的结果也就存储在了 <code>Block</code> 中。</p><p>向下寻找调用上面 AES CBC 解密的部分：</p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">char</span> v45<span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// [rsp+1C0h] [rbp+C0h] BYREF</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  <span class="token function">sub_18000B060</span><span class="token punctuation">(</span>Block<span class="token punctuation">,</span> <span class="token operator">*</span>v12<span class="token punctuation">,</span> v13<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 改名叫做 spec_func 吧</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token function">sub_180007000</span><span class="token punctuation">(</span>v45<span class="token punctuation">,</span> v32<span class="token punctuation">,</span> v10<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token function">aes_cbc_decrypt</span><span class="token punctuation">(</span><span class="token punctuation">(</span>__int64<span class="token punctuation">)</span>v45<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> __int8 <span class="token operator">*</span><span class="token punctuation">)</span>Block<span class="token punctuation">,</span> v13<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>在调用了 <code>aes_cbc_decrypt</code> 之前，先执行了 <code>sub_180007000</code> 这个函数，并且这个函数的一个参数 <code>v45</code> 是作为解密密钥传进去的，所以说 <code>sub_180007000</code> 大概率是轮密钥的生成函数。这里在该函数处下断点，通过 IDA 动态调试。</p><p>然而这里和分析有出入的地方在于，查看内存里面的信息发现 aes_cbc_decrypt 执行之后， <code>Block</code> 里面并不是 <code>atom.js</code> 的明文。</p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">spec_func</span><span class="token punctuation">(</span><span class="token punctuation">(</span>__m128i <span class="token operator">*</span><span class="token punctuation">)</span>v32<span class="token punctuation">,</span> <span class="token operator">&amp;</span>v46<span class="token punctuation">,</span> <span class="token number">0x20u</span>i64<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  v33 <span class="token operator">=</span> v11<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  v12 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">const</span> __m128i <span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">sub_7FFDEBB85C00</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>v30<span class="token punctuation">,</span> <span class="token operator">&amp;</span>v27<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  v13 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>v12<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">*</span>v12<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  Block <span class="token operator">=</span> operator <span class="token function">new</span><span class="token punctuation">(</span>v13<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token function">spec_func</span><span class="token punctuation">(</span><span class="token punctuation">(</span>__m128i <span class="token operator">*</span><span class="token punctuation">)</span>Block<span class="token punctuation">,</span> <span class="token operator">*</span>v12<span class="token punctuation">,</span> v13<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token function">sub_7FFDEBB87000</span><span class="token punctuation">(</span><span class="token punctuation">(</span>__int64<span class="token punctuation">)</span>v45<span class="token punctuation">,</span> <span class="token punctuation">(</span>__int64<span class="token punctuation">)</span>v32<span class="token punctuation">,</span> v10<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token function">aes_cbc_decrypt</span><span class="token punctuation">(</span><span class="token punctuation">(</span>__int64<span class="token punctuation">)</span>v45<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> __int8 <span class="token operator">*</span><span class="token punctuation">)</span>Block<span class="token punctuation">,</span> v13<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  v14 <span class="token operator">=</span> <span class="token punctuation">(</span>__m128i <span class="token operator">*</span><span class="token punctuation">)</span>operator <span class="token function">new</span><span class="token punctuation">(</span>v13 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token function">spec_func</span><span class="token punctuation">(</span>v14<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">const</span> __m128i <span class="token operator">*</span><span class="token punctuation">)</span>Block<span class="token punctuation">,</span> v13<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//&lt;--- 到这里之后才是 v14 里面是明文</span></pre></td></tr></table></figure><p>进入 <code>spec_func(__m128i *a1, const __m128i *a2, unsigned __int64 a3)</code> 里面的话，这里是将参数 <code>a2</code> 指向的数据存入 <code>a1</code> 指向的数据。</p><p>这样子我们再回头看这几个函数：</p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">spec_func</span><span class="token punctuation">(</span><span class="token punctuation">(</span>__m128i <span class="token operator">*</span><span class="token punctuation">)</span>v32<span class="token punctuation">,</span> <span class="token operator">&amp;</span>v46<span class="token punctuation">,</span> <span class="token number">0x20u</span>i64<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// &lt;-- 将 v46 存放的 Key 放入 v32</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  v33 <span class="token operator">=</span> v11<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  v12 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">const</span> __m128i <span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">sub_7FFDEBB85C00</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>v30<span class="token punctuation">,</span> <span class="token operator">&amp;</span>v27<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  v13 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>v12<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">*</span>v12<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  Block <span class="token operator">=</span> operator <span class="token function">new</span><span class="token punctuation">(</span>v13<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token function">spec_func</span><span class="token punctuation">(</span><span class="token punctuation">(</span>__m128i <span class="token operator">*</span><span class="token punctuation">)</span>Block<span class="token punctuation">,</span> <span class="token operator">*</span>v12<span class="token punctuation">,</span> v13<span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token function">sub_7FFDEBB87000</span><span class="token punctuation">(</span><span class="token punctuation">(</span>__int64<span class="token punctuation">)</span>v45<span class="token punctuation">,</span> <span class="token punctuation">(</span>__int64<span class="token punctuation">)</span>v32<span class="token punctuation">,</span> v10<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// &lt;-- 轮密钥派生</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token function">aes_cbc_decrypt</span><span class="token punctuation">(</span><span class="token punctuation">(</span>__int64<span class="token punctuation">)</span>v45<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> __int8 <span class="token operator">*</span><span class="token punctuation">)</span>Block<span class="token punctuation">,</span> v13<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// &lt;-- 解密</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  v14 <span class="token operator">=</span> <span class="token punctuation">(</span>__m128i <span class="token operator">*</span><span class="token punctuation">)</span>operator <span class="token function">new</span><span class="token punctuation">(</span>v13 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token function">spec_func</span><span class="token punctuation">(</span>v14<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">const</span> __m128i <span class="token operator">*</span><span class="token punctuation">)</span>Block<span class="token punctuation">,</span> v13<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//&lt;--- 到这里之后才是 v14 里面是明文</span></pre></td></tr></table></figure><p>我们导出 <code>v46</code> 中存放的数据：</p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">auto</span> file<span class="token punctuation">,</span> fname<span class="token punctuation">,</span> i<span class="token punctuation">,</span> address<span class="token punctuation">,</span> size<span class="token punctuation">,</span> x<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>address <span class="token operator">=</span> <span class="token comment">/* &amp;v46 */</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>size <span class="token operator">=</span> <span class="token number">32</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>fname <span class="token operator">=</span> <span class="token string">"C:\\Users\\syml\\Desktop\\typora-crack\\key.txt"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>file <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span>fname<span class="token punctuation">,</span> <span class="token string">"wb"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">for</span> <span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>size<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">,</span> address<span class="token operator">++</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre> x <span class="token operator">=</span> <span class="token function">DbgByte</span><span class="token punctuation">(</span>address<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre> <span class="token function">fputc</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> file<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token function">fclose</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>CBC 模式的 IV 是密文的前 16 字节，我们可以完成解密脚本：</p><figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">from</span> Crypto<span class="token punctuation">.</span>Cipher <span class="token keyword">import</span> AES</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">from</span> Crypto<span class="token punctuation">.</span>Util<span class="token punctuation">.</span>Padding <span class="token keyword">import</span> unpad</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> base64</pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'key.txt'</span><span class="token punctuation">,</span> <span class="token string">'rb'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f1<span class="token punctuation">,</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">"atom.js"</span><span class="token punctuation">,</span> <span class="token string">"rb"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f2<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    key <span class="token operator">=</span> f1<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    ciphertext <span class="token operator">=</span> base64<span class="token punctuation">.</span>b64decode<span class="token punctuation">(</span>f2<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre>iv <span class="token operator">=</span> ciphertext<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span><span class="token number">16</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="10"></td><td><pre>ciphertext <span class="token operator">=</span> ciphertext<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">:</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="11"></td><td><pre>aes <span class="token operator">=</span> AES<span class="token punctuation">.</span>new<span class="token punctuation">(</span>key<span class="token punctuation">,</span> AES<span class="token punctuation">.</span>MODE_CBC<span class="token punctuation">,</span> iv<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="12"></td><td><pre>plaintext <span class="token operator">=</span> aes<span class="token punctuation">.</span>decrypt<span class="token punctuation">(</span>ciphertext<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">"atom_decrypt.js"</span><span class="token punctuation">,</span> <span class="token string">"wb"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>unpad<span class="token punctuation">(</span>plaintext<span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr></table></figure><h1 id="混淆的javascript"><a class="anchor" href="#混淆的javascript">#</a> 混淆的 JavaScript</h1><p>本来以为折腾完外面的 AES 加密就完事了，但是实际上之前折腾最久的还是改里面 javascript 代码的逻辑……</p><p>解密之后出来的是大量的经过压缩的 js 代码，首先先格式化一下，得到稍微适合人类阅读一点的代码。（但是所有的变量名都没有了，这是痛苦的）</p><p><img loading="lazy" data-src="active_typora.jpg" alt=""></p><p>根据 Typora 的授权页面的特点，我们重点去搜索 <code>License</code> 、 <code>Invalid</code> 这样的字符串，找到了这部分代码：</p><figure class="highlight javascript"><figcaption data-lang="javascript"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">(</span>m<span class="token punctuation">.</span><span class="token function">handle</span><span class="token punctuation">(</span></pre></td></tr><tr><td data-num="2"></td><td><pre>              <span class="token string">"addLicense"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="3"></td><td><pre>              <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">e<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">email</span><span class="token operator">:</span> t<span class="token punctuation">,</span> <span class="token literal-property property">license</span><span class="token operator">:</span> n<span class="token punctuation">,</span> <span class="token literal-property property">force</span><span class="token operator">:</span> o <span class="token punctuation">&#125;</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>                <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>                  <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">e<span class="token punctuation">,</span> t<span class="token punctuation">,</span> n</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>                    <span class="token keyword">if</span> <span class="token punctuation">(</span></pre></td></tr><tr><td data-num="7"></td><td><pre>                      <span class="token punctuation">(</span><span class="token punctuation">(</span>e <span class="token operator">=</span> <span class="token punctuation">(</span>e <span class="token operator">||</span> <span class="token string">""</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="8"></td><td><pre>                        <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^[\s\u200b ]</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="9"></td><td><pre>                        <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">[\s\u200b ]$</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="10"></td><td><pre>                      <span class="token punctuation">(</span>t <span class="token operator">=</span> <span class="token punctuation">(</span>t <span class="token operator">||</span> <span class="token string">""</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="11"></td><td><pre>                        <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^[\s\u200b ]</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="12"></td><td><pre>                        <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">[\s\u200b ]$</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="13"></td><td><pre>                      <span class="token operator">!</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^[^\s@'"/\\=?]+@[^\s@'"/\\]+\.[^\s@'"/\\]+$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="14"></td><td><pre>                    <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="15"></td><td><pre>                      <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token operator">!</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"Please input a valid email address"</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token constant">Y</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token operator">!</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"Please input a valid license code"</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>可以看到这一部分是实现对输入邮箱和序列号的本地验证。其中验证序列号的函数 <code>Y(t)</code> 是这样的：</p><figure class="highlight javascript"><figcaption data-lang="javascript"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">const</span> <span class="token function-variable function">Y</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">const</span> r <span class="token operator">=</span> <span class="token string">"L23456789ABCDEFGHJKMNPQRSTUVWXYZ"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^([A-Z0-9]&#123;6&#125;-)&#123;3&#125;[A-Z0-9]&#123;6&#125;$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token operator">!</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token comment">// 验证格式</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">var</span> e <span class="token operator">=</span> e<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">-</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        t <span class="token operator">=</span> e<span class="token punctuation">.</span><span class="token function">substr</span><span class="token punctuation">(</span><span class="token number">22</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token keyword">return</span> <span class="token punctuation">(</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token operator">!</span>e<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">[L23456789ABCDEFGHJKMNPQRSTUVWXYZ]</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        t <span class="token operator">==</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> t <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">,</span> n <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> n <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">;</span> n<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> o <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">16</span><span class="token punctuation">;</span> i <span class="token operator">+=</span> <span class="token number">2</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="13"></td><td><pre>                o <span class="token operator">+=</span> r<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>e<span class="token punctuation">[</span>n <span class="token operator">+</span> i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>            <span class="token punctuation">(</span>o <span class="token operator">%=</span> r<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>t <span class="token operator">+=</span> r<span class="token punctuation">[</span>o<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>            <span class="token keyword">return</span> t<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>            <span class="token comment">// 校验？</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr></table></figure><p>可以直接删除这部分逻辑，强制返回 <code>true</code> 。</p><p>接下来，负责激活的函数生成一个请求 json，其中包含了版本、序列号、邮箱和设备信息等。</p><figure class="highlight javascript"><figcaption data-lang="javascript"></figcaption><table><tr><td data-num="1"></td><td><pre>t <span class="token operator">=</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>        <span class="token literal-property property">v</span><span class="token operator">:</span> <span class="token constant">A</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"|"</span> <span class="token operator">+</span> l<span class="token punctuation">.</span><span class="token function">getVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="3"></td><td><pre>        <span class="token literal-property property">license</span><span class="token operator">:</span> t<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token literal-property property">email</span><span class="token operator">:</span> e<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token literal-property property">l</span><span class="token operator">:</span> <span class="token keyword">await</span> <span class="token constant">G</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 获取主机名</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token literal-property property">f</span><span class="token operator">:</span> <span class="token keyword">await</span> <span class="token constant">M</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 获取机器码</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token literal-property property">u</span><span class="token operator">:</span> l<span class="token punctuation">.</span>setting<span class="token punctuation">.</span><span class="token function">generateUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token literal-property property">type</span><span class="token operator">:</span> global<span class="token punctuation">.</span>devVersion <span class="token operator">?</span> <span class="token string">"dev"</span> <span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token literal-property property">force</span><span class="token operator">:</span> n<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>这部分信息会被发送给验证服务器，并返回一个结果：</p><figure class="highlight javascript"><figcaption data-lang="javascript"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>        <span class="token keyword">var</span> o <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token constant">R</span><span class="token punctuation">(</span><span class="token string">"api/client/activate"</span><span class="token punctuation">,</span> t<span class="token punctuation">,</span> <span class="token operator">!</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 发送请求</span></pre></td></tr><tr><td data-num="3"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>o<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span></pre></td></tr><tr><td data-num="6"></td><td><pre>            <span class="token string">"[License] response code is "</span> <span class="token operator">+</span> o<span class="token punctuation">.</span>data<span class="token punctuation">.</span>code</pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        o<span class="token punctuation">.</span>data<span class="token punctuation">.</span>code <span class="token operator">==</span> <span class="token constant">D</span><span class="token punctuation">.</span><span class="token constant">SUCCESS</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">await</span> <span class="token constant">Z</span><span class="token punctuation">(</span>o<span class="token punctuation">.</span>data<span class="token punctuation">.</span>msg<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="11"></td><td><pre>            <span class="token operator">?</span> <span class="token punctuation">[</span><span class="token operator">!</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="12"></td><td><pre>            <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token operator">!</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"Please input a valid license code"</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>我们可以直接修改代码中的 <code>o.data.code</code> 字段来将返回值强制设定为 <code>SUCCESS</code> 以通过验证。接下来我们来看函数 <code>Z(o.data.msg)</code> 。</p><figure class="highlight javascript"><figcaption data-lang="javascript"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token constant">Z</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>        <span class="token keyword">var</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">fingerprint</span><span class="token operator">:</span> t<span class="token punctuation">,</span> <span class="token literal-property property">email</span><span class="token operator">:</span> n<span class="token punctuation">,</span> <span class="token literal-property property">license</span><span class="token operator">:</span> o<span class="token punctuation">,</span> <span class="token literal-property property">type</span><span class="token operator">:</span> i <span class="token punctuation">&#125;</span> <span class="token operator">=</span> <span class="token constant">I</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token keyword">return</span> t <span class="token operator">==</span> <span class="token punctuation">(</span><span class="token keyword">await</span> <span class="token constant">M</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> n <span class="token operator">&amp;&amp;</span> o</pre></td></tr><tr><td data-num="5"></td><td><pre>            <span class="token operator">?</span> <span class="token punctuation">(</span><span class="token constant">H</span><span class="token punctuation">(</span>n<span class="token punctuation">,</span> o<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="6"></td><td><pre>            <span class="token function">d</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span></pre></td></tr><tr><td data-num="7"></td><td><pre>                <span class="token string">"SLicense"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="8"></td><td><pre>                e <span class="token operator">+</span> <span class="token string">"#0#"</span> <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLocaleDateString</span><span class="token punctuation">(</span><span class="token string">"en-US"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="9"></td><td><pre>            <span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="10"></td><td><pre>            <span class="token punctuation">(</span>s <span class="token operator">=</span> <span class="token operator">!</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="11"></td><td><pre>            <span class="token operator">:</span> <span class="token punctuation">(</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"[License] validate server return fail"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">V</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">!</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token keyword">throw</span> <span class="token punctuation">(</span></pre></td></tr><tr><td data-num="14"></td><td><pre>            <span class="token punctuation">(</span>console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>stack<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">"WriteActivationInfoFail"</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>这个函数首先通过一个 <code>I(e)</code> 将 <code>o.data.msg</code> 解析为一个字典格式，接下来比较其中的 fingerprint 和本地机器码是否一样，同时判断是否存在 <code>email</code> 和 <code>license</code> 。如果一样则执行下面的函数 <code>H(n,o,i)</code> 和 <code>d().put()</code> 。</p><p>查看 <code>d().put(key, value)</code> 方法的定义我们可以知道，这个函数是将注册表中 <code>SFOTWARE/Typora</code> 下的 <code>key</code> 值设置为 <code>value</code> ，在这里也就是将服务器返回的 <code>o.data.msg</code> 拼接上 <code>#0#</code> 和当前日期写入 Typora 注册表对应的 <code>SLicense</code> 键中。 <code>H(n,o,i)</code> 则是设置了一些参数并且将当前窗口上的 <code>UNREGISTERED×</code> 标签去掉。</p><p>那么重点就在于分析 <code>I(e)</code> 这个函数。</p><figure class="highlight javascript"><figcaption data-lang="javascript"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">const</span> <span class="token function-variable function">I</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>e<span class="token punctuation">)</span> <span class="token keyword">return</span> e<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>            <span class="token keyword">var</span> t<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>              t <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> <span class="token string">"base64"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>              <span class="token keyword">const</span> n <span class="token operator">=</span> <span class="token function">a</span><span class="token punctuation">(</span><span class="token number">289</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">publicDecrypt</span><span class="token punctuation">(</span></pre></td></tr><tr><td data-num="7"></td><td><pre>                <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">-----BEGIN PUBLIC KEY-----</span></span></pre></td></tr><tr><td data-num="8"></td><td><pre>MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA7nVoGCHqIMJyqgALEUrc</pre></td></tr><tr><td data-num="9"></td><td><pre>......</pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token template-punctuation string">`</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="11"></td><td><pre>                t</pre></td></tr><tr><td data-num="12"></td><td><pre>              <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>              <span class="token keyword">return</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">"utf8"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>            <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>              <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>          <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr></table></figure><p>这个函数传入的数据通过 base64 解密，并通过一个公钥解密得到一个 json 形式的字符串。</p><p>这个字符串根据前面的内容也就是设备的指纹、邮箱和 license，服务器对我们提交的信息进行了验证并使用自己的私钥进行了签名。因为无法获取到服务器的私钥，所以我们也无法直接去伪造这个数据。不过我们可以直接修改这函数使其直接返回一个固定的字典格式的数据。这样，无论我们提交上去了什么样的数据，服务器返回怎么样的报错信息，状态码都会被设置为 <code>SUCCESS</code> ，且 <code>I(e)</code> 都会返回一个在本地看起来有效的数据。这个数据会被函数 <code>Z</code> 写入本地注册表并在每一次读取中生效。</p><p>另一处对本地注册表的引用在这里。</p><figure class="highlight javascript"><figcaption data-lang="javascript"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function-variable function">_</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">const</span> e <span class="token operator">=</span> <span class="token function">d</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"SLicense"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>e<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">var</span> <span class="token punctuation">[</span>t<span class="token punctuation">,</span> n<span class="token punctuation">,</span> o<span class="token punctuation">]</span> <span class="token operator">=</span> e<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">"#"</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        t <span class="token operator">=</span> <span class="token constant">I</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token keyword">return</span> t <span class="token operator">&amp;&amp;</span> t<span class="token punctuation">.</span>fingerprint <span class="token operator">==</span> i</pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token operator">?</span> <span class="token punctuation">(</span>Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">failCounts</span><span class="token operator">:</span> n<span class="token punctuation">,</span> <span class="token literal-property property">lastRetry</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> t<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr></table></figure><p>这里程序会读取注册表项中的 <code>SLicense</code> 并且验证其是否有效。当然对于经过修改的程序，这是始终有效的。此外还有授权的验证部分：</p><figure class="highlight javascript"><figcaption data-lang="javascript"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>        <span class="token function">ee</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>        <span class="token keyword">const</span> e <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">a</span><span class="token punctuation">(</span><span class="token number">225</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token constant">E</span> <span class="token operator">+</span> <span class="token string">"/api/client/renew"</span><span class="token punctuation">,</span> n<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>            <span class="token literal-property property">timeout</span><span class="token operator">:</span> <span class="token number">4e4</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="5"></td><td><pre>            <span class="token literal-property property">headers</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token string-property property">"Cache-Control"</span><span class="token operator">:</span> <span class="token string">"no-cache"</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="8"></td><td><pre>            e<span class="token punctuation">.</span>data<span class="token punctuation">.</span>success <span class="token operator">||</span></pre></td></tr><tr><td data-num="9"></td><td><pre>            <span class="token punctuation">(</span>console<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"[renewL]: unfill due to renew fail"</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="10"></td><td><pre>            <span class="token constant">V</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>data<span class="token punctuation">.</span>msg<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="11"></td><td><pre>            <span class="token function">d</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"SLicense"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>e<span class="token punctuation">.</span>data<span class="token punctuation">.</span>msg<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> o<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">"#"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        e<span class="token punctuation">.</span>stack<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="14"></td><td><pre>            r<span class="token punctuation">.</span><span class="token function">captureException</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">level</span><span class="token operator">:</span> <span class="token string">"warning"</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="15"></td><td><pre>            console<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"Failed to Renew L"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token keyword">var</span> <span class="token punctuation">[</span>t<span class="token punctuation">,</span> n<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token function">d</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"SLicense"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">"#"</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="17"></td><td><pre>            i <span class="token operator">=</span> <span class="token punctuation">[</span>t<span class="token punctuation">,</span> <span class="token punctuation">(</span>n <span class="token operator">=</span> <span class="token operator">+</span>n <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> o<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">"#"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token function">d</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"SLicense"</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>这一段代码会验证本地的 <code>SLicense</code> 是否正确，因此我们需要将这一段代码进行修改或是直接删去。</p><p>这样就能基本上完成对软件的破解。</p><p>在完成对 <code>atom.js</code> 的修改之后，需要重新对文件进行加密和打包。</p><figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">from</span> Crypto<span class="token punctuation">.</span>Cipher <span class="token keyword">import</span> AES</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">from</span> Crypto<span class="token punctuation">.</span>Util<span class="token punctuation">.</span>Padding <span class="token keyword">import</span> pad</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> base64</pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'iv.txt'</span><span class="token punctuation">,</span> <span class="token string">'rb'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f1<span class="token punctuation">,</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'key.txt'</span><span class="token punctuation">,</span> <span class="token string">'rb'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f2<span class="token punctuation">,</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">"atom_decrypt.js"</span><span class="token punctuation">,</span> <span class="token string">"rb"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f3<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    iv <span class="token operator">=</span> f1<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    key <span class="token operator">=</span> f2<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    plaintext <span class="token operator">=</span> f3<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre>aes <span class="token operator">=</span> AES<span class="token punctuation">.</span>new<span class="token punctuation">(</span>key<span class="token punctuation">,</span> AES<span class="token punctuation">.</span>MODE_CBC<span class="token punctuation">,</span> iv<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="11"></td><td><pre>ciphertext <span class="token operator">=</span> aes<span class="token punctuation">.</span>encrypt<span class="token punctuation">(</span>pad<span class="token punctuation">(</span>plaintext<span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="12"></td><td><pre>ciphertext <span class="token operator">=</span> iv <span class="token operator">+</span> ciphertext</pre></td></tr><tr><td data-num="13"></td><td><pre>base64_cipher <span class="token operator">=</span> base64<span class="token punctuation">.</span>b64encode<span class="token punctuation">(</span>ciphertext<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">"atom.js"</span><span class="token punctuation">,</span> <span class="token string">"wb"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>base64_cipher<span class="token punctuation">)</span></pre></td></tr></table></figure><p>打包的指令为 <code>asar pack &lt;sources&gt; &lt;target&gt;</code> 。替换原先的文件即可完成。</p><p><img loading="lazy" data-src="crack.jpg" alt=""></p><h1 id="总结"><a class="anchor" href="#总结">#</a> 总结</h1><p>许多地方都在强调的一点是，Electron 做了一个打包工作，诸如 asar 这样的实际上是不能保证源码的安全的。</p><p>参考资料中 electron-asar-encrypt-demo 这个项目所做的就是利用 C++ 进行了一层封装，将源码进行了加密以保证安全。但是像 Typora 这样的在 <code>APPDATA/Loca/Temp</code> 下面也是能够找到未加密的 node js 源码，所以这个过程做的更多的还是保护一个防篡改的功能。</p><p>但是显然简单的 AES-CBC 是防不了篡改的……</p><p>所以说理论上应该有一些更有效的手段吧？比如对源码先加上一个哈希？或者用私钥对源码进行签名？</p><p>不过这样的手段还是能够通过 patch 可执行文件来解决…… 不过这样增加了破解的难度效果恐怕还是不错的吧……</p><h1 id="参考资料"><a class="anchor" href="#参考资料">#</a> 参考资料</h1><p>[0] <a target="_blank" rel="noopener" href="https://typora.io/">https://typora.io/</a></p><p>[1] <a target="_blank" rel="noopener" href="https://www.52pojie.cn/thread-1553967-1-1.html">https://www.52pojie.cn/thread-1553967-1-1.html</a></p><p>[2] <a target="_blank" rel="noopener" href="https://github.com/Mas0nShi/typoraCracker">https://github.com/Mas0nShi/typoraCracker</a></p><p>[3] <a target="_blank" rel="noopener" href="https://github.com/toyobayashi/electron-asar-encrypt-demo">https://github.com/toyobayashi/electron-asar-encrypt-demo</a></p><p>[4] <a target="_blank" rel="noopener" href="https://github.com/electron/asar">https://github.com/electron/asar</a></p><div class="tags"><a href="/tags/%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B/" rel="tag"><i class="ic i-tag"></i>逆向工程</a></div></div><footer><div class="meta"><span class="item"><span class="icon"><i class="ic i-eye"></i></span><span class="text">总访问量：</span><span class="waline-pageview-count" id="twikoo_visitors" data-path="/2022/04/07/typora-reverse-engineering/">加载中...</span></span><span class="item"><span class="icon"><i class="ic i-calendar-check"></i></span><span class="text">更新于 </span><time title="修改时间：2025-09-10 14:48:49" itemprop="dateModified" datetime="2025-09-10T14:48:49+08:00">2025-09-10</time></span></div><div id="copyright"><ul><li class="author"><strong>本文作者：</strong>神隐陌路/symlPigeon<i class="ic i-at"><em>@</em></i>symlpigeon's little gensokyo</li><li class="link"><strong>本文链接：</strong><a href="http://symlpigeon.github.io/2022/04/07/typora-reverse-engineering/" title="针对Typora的逆向分析">http://symlpigeon.github.io/2022/04/07/typora-reverse-engineering/</a></li><li class="license"><strong>版权声明：</strong>本站所有文章除特别声明外，均采用 <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div></footer></article></div><div class="post-nav"><div class="item left"><a href="/2022/03/30/stackoverflow-ret2libc/" rel="prev" itemprop="url" data-background-image="&#x2F;assets&#x2F;bgimgs&#x2F;8f9c6cc1ly8h18bgj8tg9j21590nstbw.jpg" title="栈溢出，ret2libc"><span class="type">上一篇</span><span class="category"><i class="ic i-flag"></i>Pwn</span><h3>栈溢出，ret2libc</h3></a></div><div class="item right"><a href="/2022/04/14/protocol-secure-chap4-1/" rel="next" itemprop="url" data-background-image="&#x2F;assets&#x2F;bgimgs&#x2F;9bd9b167gy1fwrsvi929yj21hc0u0n2v.jpg" title="密钥分配和用户认证协议-I"><span class="type">下一篇</span><span class="category"><i class="ic i-flag"></i>密钥分配与认证</span><h3>密钥分配和用户认证协议-I</h3></a></div></div><div class="wrap" id="comments"></div></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="文章目录"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%A4%96%E9%9D%A2%E7%9A%84%E4%BF%9D%E6%8A%A4"><span class="toc-number">1.</span> <span class="toc-text">外面的保护</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%B7%B7%E6%B7%86%E7%9A%84javascript"><span class="toc-number">2.</span> <span class="toc-text">混淆的 JavaScript</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">3.</span> <span class="toc-text">总结</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="toc-number">4.</span> <span class="toc-text">参考资料</span></a></li></ol></div><div class="related panel pjax" data-title="系列文章"><ul><li class="active"><a href="/2022/04/07/typora-reverse-engineering/" rel="bookmark" title="针对Typora的逆向分析">针对Typora的逆向分析</a></li></ul></div><div class="overview panel" data-title="站点概览"><div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="image" loading="lazy" decoding="async" itemprop="image" alt="神隐陌路/symlPigeon" src="/assets/avatar.png"><p class="name" itemprop="name">神隐陌路/symlPigeon</p><div class="description" itemprop="description">夢違え、幻の朝靄の世界の記憶を</div></div><nav class="state"><div class="item posts"><a href="/archives/"><span class="count">50</span><span class="name">文章</span></a></div><div class="item categories"><a href="/categories/"><span class="count">36</span><span class="name">分类</span></a></div><div class="item tags"><a href="/tags/"><span class="count">45</span><span class="name">标签</span></a></div></nav><div class="social"><a target="_blank" rel="noopener" href="https://github.com/symlpigeon" class="item github" title="https:&#x2F;&#x2F;github.com&#x2F;symlpigeon"><i class="ic i-github"></i></a><a target="_blank" rel="noopener" href="https://music.163.com/#/user/home?id=540913144" class="item music" title="https:&#x2F;&#x2F;music.163.com&#x2F;#&#x2F;user&#x2F;home?id&#x3D;540913144"><i class="ic i-cloud-music"></i></a><a href="mailto:2163953074@qq.com" class="item email" title="mailto:2163953074@qq.com"><i class="ic i-envelope"></i></a><a target="_blank" rel="noopener" href="https://stackoverflow.com/users/20091462/symlpigeon" class="item stackoverflow" title="https:&#x2F;&#x2F;stackoverflow.com&#x2F;users&#x2F;20091462&#x2F;symlpigeon"><i class="ic i-stack-overflow"></i></a></div><div class="menu"><li class="item"><a href="/" rel="section"><i class="ic i-home"></i>首页</a></li><li class="item"><a href="/about/" rel="section"><i class="ic i-user"></i>关于</a></li><li class="item dropdown"><a href="#" onclick="return!1"><i class="ic i-feather"></i>文章</a><ul class="submenu"><li class="item"><a href="/archives/" rel="section"><i class="ic i-list-alt"></i>归档</a></li><li class="item"><a href="/categories/" rel="section"><i class="ic i-th"></i>分类</a></li><li class="item"><a href="/tags/" rel="section"><i class="ic i-tags"></i>标签</a></li></ul></li><li class="item"><a href="/statistics/" rel="section"><i class="ic i-clock"></i>统计</a></li><li class="item"><a href="/friends/" rel="section"><i class="ic i-heart"></i>友链</a></li></div></div></div></div><ul id="quick"><li class="prev pjax"><a href="/2022/04/14/protocol-secure-chap4-1/" rel="prev" title="上一篇"><i class="ic i-chevron-left"></i></a></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"><a href="/2022/03/30/stackoverflow-ret2libc/" rel="next" title="下一篇"><i class="ic i-chevron-right"></i></a></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div></main><footer id="footer"><div class="inner"><div class="widgets"></div><div class="status"><div class="copyright">&copy; 2021 -<span itemprop="copyrightYear">2025</span><span class="with-love"><i class="ic i-sakura rotate"></i></span><span class="author" itemprop="copyrightHolder">神隐陌路/symlPigeon @ Another Gensokyo</span></div><div class="count"><span class="post-meta-item-icon"><i class="ic i-chart-area"></i></span><span title="站点总字数">421k 字</span><span class="post-meta-divider"> | </span><span class="post-meta-item-icon"><i class="ic i-coffee"></i></span><span title="站点阅读时长">6:22</span></div><div class="powered-by">基于 <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a> & Theme.<a target="_blank" rel="noopener" href="https://github.com/theme-shoka-x/hexo-theme-shokaX/">ShokaX</a></div></div><script src="https://unpkg.com/busuanzi@2.3.0/bsz.pure.mini.js"></script><div id="busuanzi-wrap"><span class="ic i-eye"></span><span id="busuanzi_container_site_pv">本站访问量 <span id="busuanzi_value_site_pv"></span> 次</span> | <span class="ic i-user"></span><span id="busuanzi_container_site_uv">本站访客量 <span id="busuanzi_value_site_uv"></span> 次</span></div></div></footer></div><script data-config type="text/javascript">var LOCAL={ispost:!0,path:"2022/04/07/typora-reverse-engineering/",favicon:{show:"（●´3｀●）やれやれだぜ",hide:"(´Д｀)大変だ！"},search:{placeholder:"文章搜索",empty:"关于 「 ${query} 」，什么也没搜到",stats:"${time} ms 内找到 ${hits} 条结果"},nocopy:"false",nocopy:!1,copyright:'复制成功，转载请遵守 <i class="ic i-creative-commons"></i>BY-NC-SA 协议。',copy_tex:!0,katex:!0,mermaid:!1,audio:void 0,fancybox:!0,outime:!0,template:'<div class="note warning"><p><span class="label warning">文章时效性提示</span><br>这是一篇发布于 {{publish}} 天前，最后一次更新在 {{updated}} 天前的文章，部分信息可能已经发生改变，请注意甄别。</p></div>',quiz:{choice:"单选题",multiple:"多选题",true_false:"判断题",essay:"问答题",gap_fill:"填空题",mistake:"错题备注"},ignores:[e=>e.includes("#"),e=>new RegExp(LOCAL.path+"$").test(e),[]]}</script><script src="undefined/undefined" crossorigin="anonymous" fetchpriority="high"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha384-ZvpUoO&#x2F;+PpLXR1lu4jmpXWu80pZlYUAfxl5NsBMWOEPSjUn&#x2F;6Z&#x2F;hRTt8+pR6L4N2" crossorigin="anonymous" fetchpriority="high"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js" integrity="sha384-Zm+UU4tdcfAm29vg+MTbfu&#x2F;&#x2F;q5B&#x2F;lInMbMCr4T8c9rQFyOv6PlfQYpB5wItcXWe7" crossorigin="anonymous" fetchpriority="high"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/justifiedGallery/3.8.1/js/jquery.justifiedGallery.min.js" integrity="sha384-TOxsBplaL96&#x2F;QDWPIUg+ye3v89qSE3s22XNtJMmCeZEep3cVDmXy1zEfZvVv+y2m" crossorigin="anonymous" fetchpriority="high"></script><script src="/js/siteInit.js?v=0.4.25" type="module" fetchpriority="high" defer></script></body></html><!-- rebuild by hexo-renderer-multi-next-markdown-it -->